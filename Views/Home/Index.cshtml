@model List<MTU.Models.DTOs.PostDto>

@{
    ViewData["Title"] = "Trang ch·ªß";
}

@* Feed Wrapper - Contains Composer and Posts *@
<div class="feed-wrapper">
    @* Post Composer *@
    <section class="feed-composer feed-card">
        <form id="create-post-form" asp-controller="Post" asp-action="Create" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <div class="feed-composer-row">
                <div class="feed-composer-avatar" aria-hidden="true">
                    <img src="@ViewBag.CurrentUserAvatar" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                </div>
                
                <div class="feed-composer-body">
                    <div class="feed-composer-inputRow">
                        <textarea 
                            id="post-content"
                            name="Content"
                            class="feed-composer-input" 
                            placeholder="Chia s·∫ª ƒëi·ªÅu g√¨ ƒë√≥ v·ªõi MTU..." 
                            rows="1"
                            style="resize: none; overflow: hidden;"
                        ></textarea>
                        <button class="feed-btn feed-btn-primary" type="submit">
                            <i class="feed-btn-icon fa-solid fa-paper-plane"></i>
                            <span class="feed-btn-text">ƒêƒÉng</span>
                        </button>
                    </div>
                    
                    <input type="file" id="post-image-input" name="Image" accept="image/*" style="display: none;" />
                    <input type="file" id="post-video-input" name="Video" accept="video/mp4,video/x-m4v,video/*" style="display: none;" />
                    <input type="file" id="post-file-input" name="Attachment" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar" style="display: none;" />
                    <input type="hidden" id="post-privacy-input" name="Privacy" value="public" />
                    <input type="hidden" id="post-feeling-input" name="Feeling" value="" />
                    
                    <div id="media-preview-container" class="image-preview-container" style="display: none;">
                        <div class="image-preview-wrapper" style="max-height: 200px; display: flex; align-items: center; justify-content: center; background: #f0f2f5; border-radius: 8px;">
                             @* Initial Preview Elements *@
                            <img id="image-preview-img" class="image-preview-img" src="" alt="Preview" style="display: none;" />
                            <video id="video-preview-el" controls style="max-height: 200px; width: 100%; display: none;"></video>
                            <div id="file-preview-el" style="display: none; padding: 20px; text-align: center;">
                                <i class="fa-solid fa-file-lines" style="font-size: 32px; color: #555;"></i>
                                <div id="file-preview-name" style="margin-top: 8px; font-weight: 500;"></div>
                            </div>

                            <button id="media-preview-remove" class="image-preview-remove" type="button" aria-label="Remove media">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="feed-composer-actions">
                        <button class="feed-btn" type="button" id="image-upload-btn" title="ƒêƒÉng ·∫£nh">
                            <i class="feed-btn-icon fa-regular fa-image" style="color: #2ecc71;"></i>
                            <span class="feed-btn-text">·∫¢nh</span>
                        </button>
                        <button class="feed-btn" type="button" id="video-upload-btn" title="ƒêƒÉng video">
                            <i class="feed-btn-icon fa-solid fa-video" style="color: #e74c3c;"></i>
                            <span class="feed-btn-text">Video</span>
                        </button>
                        <button class="feed-btn" type="button" id="file-upload-btn" title="ƒêƒÉng t√†i li·ªáu">
                            <i class="feed-btn-icon fa-solid fa-paperclip" style="color: #3498db;"></i>
                            <span class="feed-btn-text">File</span>
                        </button>
                        <div class="privacy-dropdown">
                            <button class="feed-btn" type="button" id="privacy-btn">
                                <i class="feed-btn-icon fa-solid fa-globe" id="privacy-icon"></i>
                                <span class="feed-btn-text" id="privacy-text">C√¥ng khai</span>
                                <i class="fa-solid fa-chevron-down" style="font-size: 12px; margin-left: 4px;"></i>
                            </button>
                            <div class="privacy-menu" id="privacy-menu">
                                <div class="privacy-option" data-value="public">
                                    <i class="fa-solid fa-globe"></i>
                                    <div>
                                        <div class="privacy-option-title">C√¥ng khai</div>
                                        <div class="privacy-option-desc">Ai c≈©ng c√≥ th·ªÉ xem</div>
                                    </div>
                                </div>
                                <div class="privacy-option" data-value="friends">
                                    <i class="fa-solid fa-user-group"></i>
                                    <div>
                                        <div class="privacy-option-title">B·∫°n b√®</div>
                                        <div class="privacy-option-desc">Ch·ªâ b·∫°n b√® c√≥ th·ªÉ xem</div>
                                    </div>
                                </div>
                                <div class="privacy-option" data-value="private">
                                    <i class="fa-solid fa-lock"></i>
                                    <div>
                                        <div class="privacy-option-title">Ri√™ng t∆∞</div>
                                        <div class="privacy-option-desc">Ch·ªâ m√¨nh t√¥i</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="feelings-wrapper" style="position: relative;">
                            <button class="feed-btn" type="button" id="feelings-btn">
                                <i class="feed-btn-icon fa-regular fa-face-smile" id="feelings-icon"></i>
                                <span class="feed-btn-text" id="feelings-text">C·∫£m x√∫c</span>
                            </button>
                            <div class="feelings-dropdown" id="feelings-dropdown">
                                <div class="feelings-header">
                                    <h4>B·∫°n ƒëang c·∫£m th·∫•y th·∫ø n√†o?</h4>
                                    <button type="button" class="feelings-close" id="feelings-close"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <div class="feelings-grid" id="feelings-grid">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </section>

    @* Story Rail - N·∫±m d∆∞·ªõi Post Composer *@
    @await Html.PartialAsync("_StoryPartial")

    <section class="feed-list">
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="feed-card" style="padding: 20px; text-align: center; color: #e74c3c;">
                <p>@ViewBag.ErrorMessage</p>
            </div>
        }
        
        @if (Model.Count == 0 && ViewBag.ErrorMessage == null)
        {
            <div class="feed-card" style="padding: 20px; text-align: center;">
                <p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª!</p>
            </div>
        }
        
        @foreach (var post in Model)
        {
            @await Html.PartialAsync("_PostCardPartial", post)
        }
    </section>

    @* Pagination Controls *@
    @if (ViewBag.TotalPages > 1)
    {
        <div class="feed-pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; margin-top: 20px;">
            @if (ViewBag.HasPreviousPage)
            {
                <a href="?page=@(ViewBag.CurrentPage - 1)" class="feed-btn" style="text-decoration: none;">
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </a>
            }
            else
            {
                <button class="feed-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
            }
            
            <span style="padding: 0 15px; font-weight: 500;">
                Page @ViewBag.CurrentPage of @ViewBag.TotalPages
            </span>
            
            @if (ViewBag.HasNextPage)
            {
                <a href="?page=@(ViewBag.CurrentPage + 1)" class="feed-btn" style="text-decoration: none;">
                    Next <i class="fa-solid fa-chevron-right"></i>
                </a>
            }
            else
            {
                <button class="feed-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            }
        </div>
    }

    @* Loading Indicator *@
    <div class="feed-loading" style="display: none;">
        <div class="lofi-spinner"></div>
        <p>ƒêang t·∫£i th√™m b√†i vi·∫øt...</p>
    </div>

    @* End of Feed Message *@
    <div class="feed-end" style="display: none;">
        <p>B·∫°n ƒë√£ xem h·∫øt t·∫•t c·∫£ b√†i vi·∫øt!</p>
    </div>
</div>

@section Scripts {
    <script src="~/js/imageHandler.js" asp-append-version="true"></script>
    <script src="~/js/interactions.js" asp-append-version="true"></script>
    <script src="~/js/privacyDropdown.js" asp-append-version="true"></script>
    <script>
        (function() {
            'use strict';

            const textarea = document.getElementById('post-content');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }

            const imageUploadBtn = document.getElementById('image-upload-btn');
            const videoUploadBtn = document.getElementById('video-upload-btn');
            const fileUploadBtn = document.getElementById('file-upload-btn');
            
            const imageInput = document.getElementById('post-image-input');
            const videoInput = document.getElementById('post-video-input');
            const fileInput = document.getElementById('post-file-input');

            const mediaPreviewContainer = document.getElementById('media-preview-container');
            const imagePreviewImg = document.getElementById('image-preview-img');
            const videoPreviewEl = document.getElementById('video-preview-el');
            const filePreviewEl = document.getElementById('file-preview-el');
            const filePreviewName = document.getElementById('file-preview-name');
            const mediaPreviewRemove = document.getElementById('media-preview-remove');

            function resetPreview() {
                mediaPreviewContainer.style.display = 'none';
                imagePreviewImg.style.display = 'none';
                imagePreviewImg.src = '';
                videoPreviewEl.style.display = 'none';
                videoPreviewEl.src = '';
                filePreviewEl.style.display = 'none';
                filePreviewName.textContent = '';
                
                // Clear all inputs
                imageInput.value = '';
                videoInput.value = '';
                fileInput.value = '';
            }

            if (imageUploadBtn && imageInput) {
                imageUploadBtn.addEventListener('click', () => { resetPreview(); imageInput.click(); });
                videoUploadBtn?.addEventListener('click', () => { resetPreview(); videoInput.click(); });
                fileUploadBtn?.addEventListener('click', () => { resetPreview(); fileInput.click(); });

                // Image Handle
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 10 * 1024 * 1024) { alert('·∫¢nh t·ªëi ƒëa 10MB'); this.value = ''; return; }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imagePreviewImg.src = e.target.result;
                            imagePreviewImg.style.display = 'block';
                            mediaPreviewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Video Handle
                videoInput?.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 100 * 1024 * 1024) { alert('Video t·ªëi ƒëa 100MB'); this.value = ''; return; }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            videoPreviewEl.src = e.target.result;
                            videoPreviewEl.style.display = 'block';
                            mediaPreviewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // File Handle
                fileInput?.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 20 * 1024 * 1024) { alert('File t·ªëi ƒëa 20MB'); this.value = ''; return; }
                        filePreviewName.textContent = file.name;
                        filePreviewEl.style.display = 'block';
                        mediaPreviewContainer.style.display = 'block';
                    }
                });

                if (mediaPreviewRemove) {
                    mediaPreviewRemove.addEventListener('click', resetPreview);
                }
            }


            // Feelings Logic
            const feelingsBtn = document.getElementById('feelings-btn');
            const feelingsDropdown = document.getElementById('feelings-dropdown');
            const feelingsClose = document.getElementById('feelings-close');
            const feelingsGrid = document.getElementById('feelings-grid');
            const feelingsIcon = document.getElementById('feelings-icon');
            const feelingsText = document.getElementById('feelings-text');
            const feelingsInput = document.getElementById('post-feeling-input');

            const feelings = [
                { icon: 'fa-face-smile', text: 'Vui v·∫ª', color: '#ffb100' },
                { icon: 'fa-heart', text: 'ƒê√°ng y√™u', color: '#ff4757' },
                { icon: 'fa-face-laugh-squint', text: 'H√†o h·ª©ng', color: '#2ed573' },
                { icon: 'fa-face-sad-tear', text: 'Bu·ªìn', color: '#5352ed' },
                { icon: 'fa-face-angry', text: 'T·ª©c gi·∫≠n', color: '#ff6b81' },
                { icon: 'fa-face-tired', text: 'M·ªát m·ªèi', color: '#747d8c' },
                { icon: 'fa-face-surprise', text: 'Ng·∫°c nhi√™n', color: '#ffa502' },
                { icon: 'fa-face-grin-hearts', text: 'H·∫°nh ph√∫c', color: '#ff4757' },
                { icon: 'fa-face-grin-stars', text: 'Tuy·ªát v·ªùi', color: '#1e90ff' },
                { icon: 'fa-face-rolling-eyes', text: 'Ch√°n', color: '#a4b0be' },
                { icon: 'fa-face-sleeping', text: 'Bu·ªìn ng·ªß', color: '#747d8c' },
                { icon: 'fa-face-dizzy', text: 'Ch√≥ng m·∫∑t', color: '#ffa502' },
            ];

            if (feelingsGrid) {
                feelings.forEach(f => {
                    const item = document.createElement('div');
                    item.className = 'feeling-item';
                    item.innerHTML = `
                        <div class="feeling-icon" style="color: ${f.color}"><i class="fa-regular ${f.icon}"></i></div>
                        <div class="feeling-text">${f.text}</div>
                    `;
                    item.addEventListener('click', () => {
                        // Reset active
                        document.querySelectorAll('.feeling-item').forEach(el => el.classList.remove('active'));
                        item.classList.add('active');
                        
                        // Update button
                        feelingsIcon.className = `feed-btn-icon fa-regular ${f.icon}`;
                        feelingsIcon.style.color = f.color;
                        feelingsText.textContent = f.text;
                        feelingsBtn.classList.add('has-feeling');
                        
                        // Update input
                        if(feelingsInput) feelingsInput.value = f.text; // Store text
                        
                        // Close dropdown
                        feelingsDropdown.classList.remove('show');
                    });
                    feelingsGrid.appendChild(item);
                });
            }

            if (feelingsBtn) {
                feelingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    feelingsDropdown.classList.toggle('show');
                });
            }

            if (feelingsClose) {
                feelingsClose.addEventListener('click', () => feelingsDropdown.classList.remove('show'));
            }

            document.addEventListener('click', (e) => {
                if (feelingsDropdown && feelingsDropdown.classList.contains('show') && !feelingsDropdown.contains(e.target) && !feelingsBtn.contains(e.target)) {
                    feelingsDropdown.classList.remove('show');
                }
            });

            const form = document.getElementById('create-post-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    
                    // Prepend feeling if exists
                    const feelingInput = document.getElementById('post-feeling-input');
                    if (feelingInput && feelingInput.value) {
                         const currentVal = textarea.value;
                         textarea.value = `Example: c·∫£m th·∫•y ${feelingInput.value} - ${currentVal}`;
                         // Ti·∫øng Vi·ªát t·ª± nhi√™n h∆°n: &quot;ƒêang c·∫£m th·∫•y Vui v·∫ª - n·ªôi dung&quot;
                         // Tuy nhi√™n ƒë·ªÉ ƒë∆°n gi·∫£n m√¨nh s·∫Ω d√πng format:
                         textarea.value = `‚Äî ƒëang c·∫£m th·∫•y ${feelingInput.value} üòÜ. \n${currentVal}`;
                    }

                    const content = textarea.value.trim();
                    const hasImage = imageInput.files.length > 0;
                    const hasVideo = videoInput?.files.length > 0;
                    const hasFile = fileInput?.files.length > 0;

                    if (!content && !hasImage && !hasVideo && !hasFile) {
                        e.preventDefault();
                        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn t·ªáp ƒë·ªÉ ƒëƒÉng b√†i');
                        return false;
                    }
                });
            }
        })();
    </script>
}
