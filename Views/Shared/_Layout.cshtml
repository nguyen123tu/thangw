<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MTU</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@400;500;600&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <!-- Core CSS - Load Order Matters -->
    <link rel="stylesheet" href="~/css/variables.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/feed.css" asp-append-version="true" />
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="~/css/post-card.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/toast.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/image-upload.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/auth.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/privacy-dropdown.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/animations.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/ai-chat.css" asp-append-version="true" />
    
    @await RenderSectionAsync("Styles", required: false)
</head>
<body class="app-body @(ViewData["IsProfilePage"] != null && (bool)(ViewData["IsProfilePage"] ?? false) ? "profile-page" : "") @(ViewData["IsSettingsPage"] != null && (bool)(ViewData["IsSettingsPage"] ?? false) ? "settings-page" : "")">
    @Html.AntiForgeryToken()
    @* Sticky Header *@
    @await Html.PartialAsync("_HeaderPartial")

    @if (ViewData["IsProfilePage"] != null && (bool)(ViewData["IsProfilePage"] ?? false))
    {
        @* Profile Page Layout - Full Width, No Sidebars *@
        <div class="profile-layout">
            @RenderBody()
        </div>
    }
    else if (ViewData["IsSettingsPage"] != null && (bool)(ViewData["IsSettingsPage"] ?? false))
    {
        @* Settings Page Layout - No Sidebars *@
        <div class="settings-layout">
            @RenderBody()
        </div>
    }
    else
    {
        @* Three-Column Grid Layout *@
        <div class="app-container">
            @* Left Sidebar - Navigation *@
            @await Html.PartialAsync("_LeftSidebarPartial")

            @* Center Column - Main Feed *@
            <main class="layout-center">
                @* Main Content *@
                @RenderBody()
            </main>

            @* Right Sidebar - Contacts *@
            @await Html.PartialAsync("_RightSidebarPartial")
        </div>
    }

    @* Footer *@
    <footer class="app-footer">
        <div class="app-footer-inner">
            <span>&copy; @DateTime.Now.Year MTU Social</span>
            <a class="app-link" asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    @* AI Assistant Widget *@
    @* AI Assistant Widget - Always visible for Dev *@
    @* @if (User.Identity?.IsAuthenticated == true) *@
    @* AI Assistant Widget - Only visible on Home Page *@
    @if (ViewContext.RouteData.Values["controller"]?.ToString() == "Home" && ViewContext.RouteData.Values["action"]?.ToString() == "Index")
    {
        <div class="ai-widget" id="aiWidget">
            <button class="ai-button" id="aiToggleBtn" title="MTU AI ">
                <i class="fa-solid fa-robot"></i>
            </button>
            
            <div class="ai-popup" id="aiPopup">
                <div class="ai-header">
                    <div class="ai-header-title">
                        <i class="fa-solid fa-sparkles"></i>
                        <h4>MTU Trợ lý AI</h4>
                    </div>
                    <button class="ai-close" id="aiCloseBtn">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="ai-body" id="aiBody">
                    <div class="ai-message bot">
                        <div class="ai-avatar">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="ai-content">
                            Xin chào! Tôi là trí tuệ nhân tạo của MTU. Tôi có thể giúp gì cho bạn hôm nay?
                        </div>
                    </div>
                </div>
                <div class="ai-footer">
                    <div class="ai-input-wrapper">
                        <input type="text" id="aiInput" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" />
                        <button id="aiSendBtn" disabled>
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    @* } *@

    @* Floating Chat Bubble Widget *@
    @if (User.Identity?.IsAuthenticated == true && ViewData["IsSettingsPage"] == null)
    {
        <div class="chat-bubble-widget" id="chatBubbleWidget">
            <button class="chat-bubble-btn" id="chatBubbleBtn" title="Tin nhắn">
                <i class="fa-solid fa-comment-dots"></i>
                <span class="chat-bubble-badge" id="chatBubbleBadge" style="display: none;">0</span>
            </button>
            
            <div class="chat-bubble-popup" id="chatBubblePopup">
                <div class="chat-popup-header">
                    <h4>Tin nhắn</h4>
                    <div class="chat-popup-actions">
                        <a href="/Messages" class="chat-popup-expand" title="Mở rộng">
                            <i class="fa-solid fa-expand"></i>
                        </a>
                        <button class="chat-popup-close" id="chatPopupClose">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-popup-body" id="chatPopupBody">
                    <div class="chat-popup-loading">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Đang tải...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .chat-bubble-widget {
                position: fixed;
                bottom: 24px;
                right: 24px;
                z-index: 1000;
            }
            
            .chat-bubble-btn {
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--lofi-sage);
                border: 3px solid var(--border-primary);
                color: white;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 4px 4px 0 var(--border-primary);
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }
            
            .chat-bubble-btn:hover {
                transform: translate(2px, 2px);
                box-shadow: 2px 2px 0 var(--border-primary);
            }
            
            .chat-bubble-badge {
                position: absolute;
                top: -4px;
                right: -4px;
                background: #ef4444;
                color: white;
                font-size: 11px;
                font-weight: 600;
                min-width: 20px;
                height: 20px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid white;
            }
            
            .chat-bubble-popup {
                position: absolute;
                bottom: 70px;
                right: 0;
                width: 340px;
                max-height: 450px;
                background: var(--lofi-cream);
                border: 3px solid var(--border-primary);
                border-radius: var(--radius-organic);
                box-shadow: 6px 6px 0 var(--border-primary);
                display: none;
                flex-direction: column;
                overflow: hidden;
            }
            
            .chat-bubble-popup.active {
                display: flex;
            }
            
            .chat-popup-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 16px;
                background: var(--lofi-sage);
                border-bottom: 3px solid var(--border-primary);
            }
            
            .chat-popup-header h4 {
                margin: 0;
                font-size: 15px;
                font-weight: 600;
                color: white;
            }
            
            .chat-popup-actions {
                display: flex;
                gap: 8px;
            }
            
            .chat-popup-expand,
            .chat-popup-close {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                transition: background 0.2s;
            }
            
            .chat-popup-expand:hover,
            .chat-popup-close:hover {
                background: rgba(255,255,255,0.3);
            }
            
            .chat-popup-body {
                flex: 1;
                overflow-y: auto;
                max-height: 380px;
            }
            
            .chat-popup-loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px;
                color: var(--lofi-muted);
                gap: 8px;
            }
            
            .chat-popup-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                cursor: pointer;
                transition: background 0.2s;
                border-bottom: 1px solid var(--border-secondary);
            }
            
            .chat-popup-item:hover {
                background: rgba(0,0,0,0.03);
            }
            
            .chat-popup-item.unread {
                background: rgba(139, 169, 131, 0.1);
            }
            
            .chat-popup-avatar {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                border: 2px solid var(--border-primary);
                object-fit: cover;
                flex-shrink: 0;
            }
            
            .chat-popup-info {
                flex: 1;
                min-width: 0;
            }
            
            .chat-popup-name {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 2px;
            }
            
            .chat-popup-preview {
                font-size: 12px;
                color: var(--text-muted);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .chat-popup-time {
                font-size: 11px;
                color: var(--text-muted);
                flex-shrink: 0;
            }
            
            .chat-popup-empty {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                text-align: center;
            }
            
            .chat-popup-empty i {
                font-size: 48px;
                color: var(--lofi-muted);
                margin-bottom: 12px;
            }
            
            .chat-popup-empty p {
                font-size: 13px;
                color: var(--text-muted);
                margin: 0;
            }
            
            /* Hide on mobile */
            @@media (max-width: 768px) {
                .chat-bubble-widget {
                    bottom: 16px;
                    right: 16px;
                }
                
                .chat-bubble-popup {
                    width: calc(100vw - 32px);
                    right: -8px;
                }
            }
        </style>
        
        <script>
        (function() {
            'use strict';
            
            const bubbleBtn = document.getElementById('chatBubbleBtn');
            const popup = document.getElementById('chatBubblePopup');
            const closeBtn = document.getElementById('chatPopupClose');
            const popupBody = document.getElementById('chatPopupBody');
            const badge = document.getElementById('chatBubbleBadge');
            let isLoaded = false;
            
            if (bubbleBtn) {
                bubbleBtn.addEventListener('click', function() {
                    popup.classList.toggle('active');
                    if (popup.classList.contains('active') && !isLoaded) {
                        loadConversations();
                    }
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    popup.classList.remove('active');
                });
            }
            
            // Close on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.chat-bubble-widget')) {
                    popup.classList.remove('active');
                }
            });
            
            async function loadConversations() {
                try {
                    const response = await fetch('/Message/GetRecentConversations');
                    const data = await response.json();
                    
                    isLoaded = true;
                    
                    if (data.success && data.conversations && data.conversations.length > 0) {
                        let unreadCount = 0;
                        popupBody.innerHTML = data.conversations.map(function(conv) {
                            if (conv.unread) unreadCount++;
                            return '<div class="chat-popup-item ' + (conv.unread ? 'unread' : '') + '" onclick="window.location.href=\'/Message/' + conv.userId + '\'">' +
                                '<img src="' + conv.avatar + '" alt="' + escapeHtml(conv.name) + '" class="chat-popup-avatar">' +
                                '<div class="chat-popup-info">' +
                                '<div class="chat-popup-name">' + escapeHtml(conv.name) + '</div>' +
                                '<div class="chat-popup-preview">' + escapeHtml(conv.lastMessage) + '</div>' +
                                '</div>' +
                                '<span class="chat-popup-time">' + conv.timeAgo + '</span>' +
                                '</div>';
                        }).join('');
                        
                        if (unreadCount > 0) {
                            badge.textContent = unreadCount;
                            badge.style.display = 'flex';
                        }
                    } else {
                        popupBody.innerHTML = '<div class="chat-popup-empty">' +
                            '<i class="fa-regular fa-comment-dots"></i>' +
                            '<p>Chưa có tin nhắn nào</p>' +
                            '</div>';
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    popupBody.innerHTML = '<div class="chat-popup-empty">' +
                        '<p>Không thể tải tin nhắn</p>' +
                        '</div>';
                }
            }
            
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Load unread count on page load
            setTimeout(function() {
                fetch('/Message/GetRecentConversations')
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.conversations) {
                            const unread = data.conversations.filter(c => c.unread).length;
                            if (unread > 0) {
                                badge.textContent = unread;
                                badge.style.display = 'flex';
                            }
                        }
                    })
                    .catch(() => {});
            }, 1000);
        })();
        </script>
    }

    @* JavaScript Files *@
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    @* MTU Dialog System - Load trước tất cả JS khác *@
    <script src="/js/dialog.js"></script>
    
    @* Fallback: Đảm bảo MTUDialog luôn tồn tại *@
    <script>
    if (typeof MTUDialog === 'undefined') {
        window.MTUDialog = {
            confirm: function(opts) {
                return Promise.resolve(window.confirm(opts.message || 'Bạn có chắc chắn không?'));
            },
            alert:   function(msg) { window.alert(msg); },
            toast:   function(msg) { console.log('[Toast]', msg); },
            success: function(msg) { window.alert(msg); },
            error:   function(msg) { window.alert(msg); },
            warning: function(msg) { window.alert(msg); },
            info:    function(msg) { window.alert(msg); }
        };
        console.warn('MTUDialog fallback active - /js/dialog.js chưa load được');
    }
    </script>
    
    <script src="~/js/soundEffects.js" asp-append-version="true"></script>
    <script src="~/js/mockData.js" asp-append-version="true"></script>
    <script src="~/js/contactsManager.js" asp-append-version="true"></script>
    <script src="~/js/feedManager.js" asp-append-version="true"></script>
    <script src="~/js/chatManager.js" asp-append-version="true"></script>
    <script src="~/js/imageHandler.js" asp-append-version="true"></script>
    <script src="~/js/interactions.js" asp-append-version="true"></script>
    @if (ViewContext.RouteData.Values["controller"]?.ToString() == "Home" && ViewContext.RouteData.Values["action"]?.ToString() == "Index")
    {
        <script src="~/js/ai-chat.js" asp-append-version="true"></script>
    }
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
